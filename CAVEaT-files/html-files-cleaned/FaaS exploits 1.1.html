<html><head><meta content="text/html; charset=utf-8" http-equiv="Content-Type"/><meta content="Microsoft Word 15 (filtered)" name="Generator"/></head><body link="blue" vlink="#954F72"><div><p>Exploiting FaaS - AWS Lambda/Azure Functions/Logic Apps(version 1.2)</p>

<p><b>Cloud Service Label: PaaS</b></p>

<p>Description</p>
<p>Both Azure and AWS employ “serverless” code functionality that can be set to automatically trigger by other events within the cloud API. Coding for these functions is a new paradigm that isn’t well understood from a security perspective. Many of the vulnerabilities associated with other programming paradigms apply but the mitigations often don’t. There really aren’t code scanners that focus on FaaS code. It’s often not feasible to protect FaaS functions with proxies or firewalls. Restricting inputs to FaaS functions is often antithetical to their reason for existing. FaaS functions often take inputs from logs that are not controlled by an application developer. Sample code has already been released showing what is possible if vulnerable FaaS functions ingest log messages that have been cleverly formatted to take advantage of coding vulnerabilities. Exploiting FaaS functions can be used both to gain initial access to a cloud enterprise, collect intelligence on internal cloud assets, to elevate privileges during an existing intrusion, and to evade detection during intrusion.</p>

<p>Examples</p>
<table border="1" cellpadding="0" cellspacing="0" width="631"><tr><td valign="top" width="208"><p><b>Name</b></p>
</td>
<td valign="top" width="89"><p><b>Tactic</b></p>
</td>
<td valign="top" width="334"><p><b>Description</b></p>
</td>
</tr>
<tr><td valign="top" width="208"><p>Puresec</p>
</td>
<td valign="top" width="89">
</td>
<td valign="top" width="334"><p>Blog posts about exploiting FaaS functions</p>
</td>
</tr>
<tr><td valign="top" width="208"><p>NetSPI</p>
</td>
<td valign="top" width="89"><p>Privilege escalation</p>
</td>
<td valign="top" width="334"><p>Demonstrates code to extract Bearer tokens from FaaS functions in Azure if you can insert code into an existing FaaS function. These tokens may have expansive rights though they are usually limited to a particular Azure service.</p>
</td>
</tr>
<tr><td valign="top" width="208"><p>NetSPI</p>
</td>
<td valign="top" width="89"><p>Persistence</p>
</td>
<td valign="top" width="334"><p>FaaS functions can be used to maintain persistence after initial access has been made. Automation accounts can create scheduled tasks or web hook to maintain persistence.</p>
</td>
</tr>
<tr><td valign="top" width="208"><p>NetSPI</p>
</td>
<td valign="top" width="89"><p>Defense Evasion</p>
</td>
<td valign="top" width="334"><p>FaaS functions can be utilized for defense evasion. There are testing functionality for automation accounts where code and other commands can be run to avoid detection since this is not logged.</p>
</td>
</tr>
<tr><td valign="top" width="208"><p>Puma Security</p>
</td>
<td valign="top" width="89"><p>Privilege escalation, persistence</p>
</td>
<td valign="top" width="334"><p>Open source scripts to access FaaS credentials from AWS, Azure and GCP</p>
</td>
</tr>
<tr><td valign="top" width="208"><p>Rhino Security Labs</p>
</td>
<td valign="top" width="89"><p>Privilege escalation</p>
</td>
<td valign="top" width="334"><p>FaaS functions can be manipulated to include custom versions of python libraries and malicious code. In an example demonstrated by Rhino Security Labs, the boto3 python library was customized and uploaded to a new Lambda layer to include code that steals the function’s environment variables.</p>
</td>
</tr>
</table>
<p>Mitigations</p>
<table border="1" cellpadding="0" cellspacing="0" width="624"><tr><td colspan="2" valign="top" width="312"><p><b>Mitigation</b></p>
</td>
<td valign="top" width="312"><p><b>Description</b></p>
</td>
</tr>
<tr><td colspan="2" valign="top" width="312"><p>Audit</p>

</td>
<td valign="top" width="312"><p>Frequently check permissions on cloud storage to ensure proper permissions are set to deny open or unprivileged access to resources. Consider using automated resource checkers such as CloudSploit or Divvycloud.Frequently check API logs for lambda/function creation events.</p>
</td>
</tr>
<tr><td valign="top" width="156">
</td>
<td valign="top" width="156"><p>AWS</p>
</td>
<td valign="top" width="312"><p>To perform an audit via AWS it is suggested to review information such as account details (credentials, users, groups, roles, etc), mobile applications, EC2 configurations, policies, and account activity. How to audit these different factors can be found in detail at:<b>https://docs.aws.amazon.com/general/latest/gr/aws-security-audit-guide.html.</b></p>
</td>
</tr>
<tr><td valign="top" width="156">
</td>
<td valign="top" width="156"><p>Azure</p>
</td>
<td valign="top" width="312"><p>To perform an audit via Azure an administrator can review the audit logs that are recorded under Azure’s monitoring for active directory. The audit logs allow for filtering, as well as looking at users, groups, and enterprise specific information. Full details on how to access this information can be found at:<b>https://docs.microsoft.com/en-us/azure/active-directory/reports-monitoring/concept-audit-logs.</b></p>
</td>
</tr>
<tr><td valign="top" width="156">
</td>
<td valign="top" width="156"><p>GCP</p>
</td>
<td valign="top" width="312"><p>To perform an audit via GCP the logs can be reviewed. GCP breaks this down into three categories; admin activity, data access, and system events. The audit logs can be viewed a few different ways- the console, API, or gcloud. Full details on how to view these logs, how to export, and for how to configure the retention period can be found here:<b>https://cloud.google.com/logging/docs/audit.</b></p>
</td>
</tr>
<tr><td colspan="2" valign="top" width="312"><p>Secure Coding</p>
</td>
<td valign="top" width="312"><p>Avoid directly processing any input that can be generated directly by a user. Parse all inputs to functions carefully.</p>
</td>
</tr>
<tr><td colspan="2" valign="top" width="312"><p>Limit Access</p>
</td>
<td valign="top" width="312"><p>Provision FaaS functions with the minimum absolute permissions possible. In AWS, ensure lambda:CreateFunction and lambda:UpdateFunctionConfiguration permissions are locked down. In Azure use Managed Identities for authorization and authentication since this makes such accesses easier to audit.</p>
</td>
</tr>
<tr><td colspan="2" valign="top" width="312"><p>Associate function with a VNET or VPC</p>
</td>
<td valign="top" width="312"><p>This may cost more in Azure’s case, but the function can be protected by CSP network protections such as security groups to prevent credentials from being used from unexpected locations</p>
</td>
</tr>
</table>
<p>Detection</p>
<p>Detecting the presence of corrupted FaaS apps is exceedingly difficult currently. More likely side effects that result from such corruption like illicit network communications or unexplained account creations are more likely to be noticed in logging. For instance in Azure service accounts (MSI) the diagnostic logs may show a token authentication from non-Microsoft address spaces using a client that is not a Microsoft agent.</p>

<p>https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation-part-2/References</p>
<p>1.https://github.com/puresec/sas-top-10 Retrieved Feb 20,2020</p>
<p>2.https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-8611 Retrieved May 14, 2020</p>
<p>3.https://blog.netspi.com/gathering-bearer-tokens-azure/#4 Retrieved June 8, 2020</p>
<p>4.https://pumasecurity.io/resources/blog/RSAC-2020-Defending-Serverless-Infrastructure-in-the-Cloud Retrieved June 9,2020 Accessed July 21, 2020</p>
</div></body></html>