<html><head></head><body link="blue" vlink="#954F72"><div><p>Exploiting Containers(version 1.0)</p>

<p><b>Cloud Service Label: PaaS, SaaS, IaaS</b></p>

<p>Docker containers utilized in the cloud can be exploited by an adversary. Azure manages containers via Azure Container Services (ACS) and Amazon manages containers via Amazon Elastic Container Service (Amazon ECS). Depending on how the infrastructure is provisioned, exploiting this could provide privilege escalation, discovery, and exfiltration opportunities.</p>

<p>Examples</p>
<table border="1" cellpadding="0" cellspacing="0"><tr><td valign="top" width="312"><p><b>Name</b></p>
</td>
<td valign="top" width="312"><p><b>Description</b></p>
</td>
</tr>
<tr><td valign="top" width="312"><p>DEF CON 27: Cloud Village Presentation</p>
</td>
<td valign="top" width="312"><p>If docker.sock (which is normally open on port 2376) is exposed and you can interact with it, you can create a new container and mount the host’s filesystem (as root), run the container, and the adversary can have root privileges to the filesystem. BOtB, is an open source tool created to automate recon and exploit of containers.</p>
</td>
</tr>
<tr><td valign="top" width="312"><p>Exposed Docker Port</p>
</td>
<td valign="top" width="312"><p>Identifying an open port associated with Docker (2376 is the most common open port by default) can lead to finding running containers and images. Most containers run with default root privileges, so running<i>docker -H 192.168.1.7:2376 exec -it &lt;container name&gt; /bin/bash</i>will automatically give you root once logged in.</p>
</td>
</tr>
</table>
<p>Mitigations</p>
<table border="1" cellpadding="0" cellspacing="0"><tr><td valign="top" width="312"><p><b>Mitigation</b></p>
</td>
<td valign="top" width="312"><p><b>Description</b></p>
</td>
</tr>
<tr><td valign="top" width="312"><p>Restrict Access to Specific Networks</p>
</td>
<td valign="top" width="312"><p>Restricting the access that Containers have to specific networks will limit the availability of data if credentials are compromised.</p>
</td>
</tr>
<tr><td valign="top" width="312"><p>Limit Access to Accounts</p>
</td>
<td valign="top" width="312"><p>A user or process with read privileges to a registry also has the ability to list and pull any images in a registry. Make sure only those that need privileges have it.</p>
</td>
</tr>
<tr><td valign="top" width="312"><p>Disable Unnecessary Ports and Services</p>

</td>
<td valign="top" width="312"><p>Ensure ports and services that are publicly accessible are locked down and disabled if necessary. In the case of Docker, port 2376 is the ssl version of Dockerd socket should not be open to the Internet.</p>

</td>
</tr>
</table>
<p>Detection</p>
<p>This can be detected by monitoring the commands being run through the cloud API. Most users/processes should not be listing and pulling images in a registry. If this happens it should be investigated. Any type of suspicious account activity should be monitored and flagged. This can include unusual log on times, connecting from unexpected devices, password changes, as well as multiple log on attempts.</p>
<table border="1" cellpadding="0" cellspacing="0"><tr><td valign="top" width="312"><p><b>Detection</b></p>
</td>
<td valign="top" width="312"><p><b>Description</b></p>
</td>
</tr>
<tr><td valign="top" width="312"><p>Create Log Metric Filters and Alarms for AWS</p>
</td>
<td valign="top" width="312"><p>To create a metric filter and alarm:</p>
<p>1.Create a metric filter that checks for IAM policy changes and the<i>&lt;cloudtrail_log_group_name&gt;</i></p>
<p>2.Create an SNS topic</p>
<p>3.Create an SNS subscription to the above topic</p>
<p>4.Create an alarm associated with the filter and SNS topic created in steps 1 and 2 respectively</p>
</td>
</tr>
<tr><td valign="top" width="312"><p>Monitor Activity in AWS Account</p>
</td>
<td valign="top" width="312"><p>Various services in AWS offer logging features that allow for detection capabilities. These include CloudFront, CloudTrail, CloudWatch, Config, and S3.</p>
</td>
</tr>
<tr><td valign="top" width="312"><p>Monitor for Suspicious Activity in Azure</p>
</td>
<td valign="top" width="312"><p>Azure AD can generate anomaly reports than can be run on a daily basis. Azure AD Identity Protection show current risks in its dashboard and provides daily email summary notifications. Policies can also be configured to alert to specific issues.</p>
</td>
</tr>
<tr><td valign="top" width="312"><p>Create Log Metric Filters and Alarms for CloudTrail</p>
</td>
<td valign="top" width="312"><p>To create a metric filter and alarm:</p>
<p>1.Create a filter that checks for CloudTrail changes and the specific<i>&lt;cloudtrail_log_group_name&gt;</i></p>
<p>2.Create an SNS topic that the alarm will notify</p>
<p>3.Create an SNS subscription to the above topic</p>
<p>4.Create an alarm associated with the filter from step 1 and SNS topic in step 2</p>
</td>
</tr>
<tr><td valign="top" width="312"><p>Create Activity Log Alerts in Azure</p>
</td>
<td valign="top" width="312"><p>To create log activity alerts for deletion in the Azure Console:</p>
<p>1.Navigate to<i>Monitor’ / ‘Alerts</i></p>
<p>2.Select<i>Manage alert rules</i></p>
<p>3.Click on the Alert<i>Name</i>where Condition contains<i>operationName equals Microsoft.Network/networkSecurityGroups/securityRules/delete</i></p>
<p>4.Hover a mouse over<i>Condition</i>to ensure it is set to<i>Whenever the Administrative Activity Log “Delete Security Rule (networkSecurityGroups/securityRules)” has “any” level with “any” status and event is initiated by “any</i>”</p>
</td>
</tr>
<tr><td valign="top" width="312"><p>Create, View, and Manage Activity Alerts in Azure Monitor</p>
</td>
<td valign="top" width="312"><p>To create a log alert in the Azure portal:</p>
<p>1.Select<b>Monitor -&gt; Alerts</b></p>
<p>2.Select<b>New alert rule</b>of the<b>Alerts</b>window</p>
<p>3.Provide information in<b>Define alert condition</b></p>
<p>4.Provide details in<b>Define alert details</b></p>
<p>5.Specify action group for new alert rule under<b>Action group</b>, or create a new action group with +<b>New group</b></p>
<p>6.Select<b>Yes</b>for the<b>Enable rule upon creation</b>option</p>
<p>7.Select<b>Create alert rule</b></p>

<p>To view and manage alerts:</p>
<p>1.Select<b>Monitor -&gt; Alerts -&gt; Manage alert rules</b></p>
<p>2.Select the rule you want to modify and double-click to edit the rule options</p>
<p>3.Click<b>Save</b></p>
</td>
</tr>
<tr><td valign="top" width="312"><p>Azure Resource Manager Templates</p>
</td>
<td valign="top" width="312"><p>Azure Resource Manager templates in the format of JSON files that can be used to configure metric alerts in Azure Monitor. These templates can be used for simple static and dynamic threshold metric alerts, availability tests, and monitoring multiple resources.</p>
</td>
</tr>
<tr><td valign="top" width="312"><p>Enable CloudTrail across all regions in AWS</p>
</td>
<td valign="top" width="312"><p>To enable CloudTrail across all regions:</p>
<p>1.Sign into the AWS Management Console and open the CloudTrail console</p>
<p>2.Click on<i>Trails</i></p>
<p>3.Set necessary Trails to All option in the I column</p>
<p>4.Click on a trail via the link<i>Name</i>column</p>
<p>5.Set<i>Logging</i>to<i>ON</i></p>
<p>6.Set<i>Apply trail to all regions</i>to<i>Yes</i></p>
</td>
</tr>
<tr><td valign="top" width="312"><p>Configure log profile to capture activity logs for all regions in Azure</p>
</td>
<td valign="top" width="312"><p>To set up activity logs for all regions:</p>
<p>1.Navigate to Azure console</p>
<p>2.Go to<i>Activity log</i></p>
<p>3.Select<i>Export</i></p>
<p>4.Select<i>Subscription</i></p>
<p>5.Check<i>Select all</i>in<i>Regions</i></p>
<p>6.Select<i>Save</i></p>
</td>
</tr>
</table>

<p>References<a name="scite-1"></a></p>
<p>1.<a href="https://rhinosecuritylabs.com/aws/cloud-container-attack-tool/">Rhino Labs. (2019, August). Exploiting AWS ECR and ECS with the Cloud Container Attack Tool (CCAT). Retrieved September 12, 2019.</a></p>
<p><a name="scite-2">2.</a><a href="https://github.com/RhinoSecurityLabs/ccat" target="_blank">Rhino Labs. (2019, September). Cloud Container Attack Tool (CCAT). Retrieved September 12, 2019.</a></p>
<p>3.<a href="http://1.https:/www.youtube.com/watch?v=1FB58EVWAOU">DEF CON 27 Cloud Village. (2019, December). Chris Le Roy - Build to Hack Hack to Build. Retrieved June 17, 2020.</a></p>
<p>4.https://docs.docker.com/engine/security/https Retrieved July 29, 2020.</p>

</div></body></html>